#!/usr/bin/env bash

function main {
  local shome="${_limbo_home:-"$(cd -P -- "$(dirname -- "$BASH_SOURCE")/.." && pwd -P)"}"
  source "$shome/script/profile"

  set -x
  rm -rf "$LXD_CONF"
  mkdir -p "$LXD_CONF"
  lxc remote remove "$BASEBOX_INSTANCE" 2>&- || true
  echo y | lxc remote add "$BASEBOX_INSTANCE" "$BASEBOX_IP" --password=ubuntu
  lxc remote set-default "$BASEBOX_INSTANCE" 

	lxc profile create limbo
	lxc profile set limbo user.user-data - < "$BLOCK_PATH/limbo/cidata/user-data"
	lxc launch xenial docker -p default -p docker -p limbo -c boot.autostart=true -c security.nesting=true -c security.privileged=true

  if [[ -n "${http_proxy:-}" ]]; then
    echo "Acquire::http::Proxy \"$http_proxy\";" | lxc exec docker -- tee /etc/apt/apt.conf.d/99boxcache
  fi

	lxc exec docker -- touch /root/.cloud-init.hostname
	lxc exec docker -- rm -rf /var/lib/cloud/instance
	lxc exec docker -- cloud-init init
	lxc exec docker -- rm -rf /var/lib/cloud/instance
	lxc exec docker -- cloud-init init

  sleep 10
	lxc exec docker -- apt update
	lxc exec docker -- env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y

	echo "DOCKER_OPTS='-H tcp://0.0.0.0:2376 -H unix:///var/run/docker.sock --storage-driver overlay --bip ${BASEBOX_DOCKER_NETWORK_PREFIX}.1/24'" | lxc exec docker -- tee /etc/default/docker
	lxc exec docker -- env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y docker.io

	lxc restart docker
  sleep 5

	lxc exec docker -- docker info
	lxc exec docker -- docker network inspect bridge
	lxc info
	lxc list
}

source sub "$BASH_SOURCE" "$@"
